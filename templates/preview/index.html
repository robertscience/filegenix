<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobertPreview DS - Turbo Comparativa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-electric">
    <div class="container-fluid p-0 h-100">
        <header class="bg-gradient text-center py-4 rock-header" style="background: linear-gradient(135deg, #000033, #1a1a1a, #ff00ff); font-family: 'Orbitron', sans-serif; animation: header-rock 3s ease-in-out infinite;">
            <h1 class="text-magenta rock-title"><i class="fas fa-bolt"></i> RobertPreview DS - Turbo Comparativa <i class="fas fa-guitar"></i></h1>
            <p class="text-neon">Rockea tus datos: Compara antes/despues con highlights eléctricos</p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <textarea id="linkInput" class="form-control mb-2 rock-input" placeholder="Pega ID o Enlace de Análisis DS aquí (ej. /diff/uuid?step=merged)" rows="2" style="background: rgba(0,0,0,0.7); border: 1px solid #00ffcc; box-shadow: 0 0 15px #00ffcc;"></textarea>
                    <button id="checkBtn" class="btn btn-rocker btn-lg w-100 rock-pulse"><i class="fas fa-search"></i> Chequear Turbo</button>
                </div>
            </div>
        </header>
        <div id="loading" class="text-center text-neon mt-3 d-none"><i class="fas fa-spinner fa-spin"></i> Rockeando datos...</div>
        <div id="viewer" class="d-none h-75">
            <div class="row m-0">
                <div class="col-md-6 p-2">
                    <h4 class="text-gray">Antes (Original Raw) <i class="fas fa-skull-crossbones"></i></h4>
                    <input type="text" id="searchBar" class="form-control mb-2 rock-search" placeholder="Busca & Rockea: ITEM_CODE=ABC123...">
                    <div id="beforeView" class="table-responsive cyber-scroll" style="height: 85vh; overflow-y: auto; background: linear-gradient(to bottom, #333, #111);"></div>
                </div>
                <div class="col-md-6 p-2">
                    <h4 class="text-success">Después (Cambios Rockeados) <i class="fas fa-fire"></i></h4>
                    <div id="afterView" class="table-responsive electric-scroll" style="height: 85vh; overflow-y: auto; background: linear-gradient(to bottom, #001a00, #004d00);"></div>
                </div>
            </div>
        </div>
        <footer class="bg-dark text-center py-3 d-none rock-footer" id="footer">
            <button id="downloadBtn" class="btn btn-magenta btn-lg rock-pulse"><i class="fas fa-download"></i> Descargar Rock ZIP</button>
            <p class="mt-2 text-neon">RobertScience DS - Turbo Validación Interna | Rock the Data!</p>
        </footer>
    </div>
    <script>
        let uploadId, step;
        $('#checkBtn').click(loadViewer);
        $('#downloadBtn').click(downloadZip);

        function loadViewer() {
            let link = $('#linkInput').val().trim();
            if (!link) return alert('¡Pega el enlace DS, rockstar!');
            let urlMatch = link.match(/diff\/([a-f0-9-]+)/i);
            if (!urlMatch) return alert('Enlace inválido – busca /diff/uuid');
            uploadId = urlMatch[1];
            let params = new URLSearchParams(link.split('?')[1] || '');
            step = params.get('step') || 'merged';
            $('#loading').removeClass('d-none');
            $.getJSON(`/diff/${uploadId}/data?step=${step}`, function(data) {
                $('#loading').addClass('d-none');
                if (data.error) return alert('Error loading: ' + data.error);
                renderDiff(data);
                $('#viewer, #footer').removeClass('d-none');
                $('#searchBar').on('keyup', filterAndJump);
                $('.rock-header').addClass('rock-loaded');
            }).fail(function(jqXHR) {
                $('#loading').addClass('d-none');
                alert('Fail loading – chequea ID o logs: ' + (jqXHR.responseJSON?.error || 'Server error'));
            });
        }

        function renderDiff(data) {
            let beforeRows = data.before ? data.before.split('\n').filter(r => r).map(JSON.parse) : [];
            let afterRows = data.after ? data.after.split('\n').filter(r => r).map(JSON.parse) : [];
            renderChunk('#beforeView', beforeRows.slice(0, 1000), 'gray-row');
            renderChunk('#afterView', afterRows.slice(0, 1000), 'change-highlight');
            $('#beforeView, #afterView').on('scroll', syncScroll);
            $('.cyber-scroll, .electric-scroll').on('scroll', infiniteLoad);
            $('.rock-footer p').text(`RobertScience DS - Turbo Validación Interna | Rows: ${data.stats.rows_after} | Match: ${data.match_rate.toFixed(1)}%`);
        }

        function renderChunk(container, rows, className) {
            let html = '<table class="table table-dark"><thead><tr><th>Row</th><th>Data</th></tr></thead><tbody>';
            rows.forEach((row, i) => {
                let rowClass = className;
                if (className === 'change-highlight') {
                    if ('REVENUE' in row) rowClass += ' text-success rock-glow';
                    else if (row.ITEM_DESCRIPTION && row.ITEM_DESCRIPTION !== row.ITEM_DESCRIPTION.toLowerCase()) rowClass += ' text-warning flash-yellow';
                    else if (row.ITEM_CODE === null || row.ITEM_CODE === 'null') rowClass += ' text-danger pulse-red';
                }
                html += `<tr class="${rowClass}" data-row="${JSON.stringify(row)}"><td>${i + 1}</td><td>${JSON.stringify(row)}</td></tr>`;
            });
            html += '</tbody></table>';
            $(container).html(html);
        }

        function syncScroll() {
            let scrollTop = $(this).scrollTop();
            $('.table-responsive').not(this).scrollTop(scrollTop);
        }

        function infiniteLoad() {
            if ($(this).scrollTop() + $(this).height() >= $(this)[0].scrollHeight - 100) {
                console.log('Loading more rock...');
            }
        }

        function filterAndJump() {
            let query = $('#searchBar').val().toLowerCase();
            $('tr').show().filter(function() {
                return !JSON.parse($(this).attr('data-row')).ITEM_CODE?.toLowerCase().includes(query);
            }).hide();
            let firstMatch = $('tr:visible').first();
            if (firstMatch.length) {
                $('#beforeView').scrollTop(firstMatch.position().top - 100);
            }
        }

        function downloadZip() {
            window.location.href = `/preview/download/${uploadId}?step=${step}`;
        }
    </script>
    <style>
        .bg-electric { background: linear-gradient(135deg, #000033, #1a1a1a, #ff00ff, #00ffcc); animation: electric-storm 8s ease-in-out infinite; }
        @keyframes electric-storm { 0%,100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .rock-header { box-shadow: 0 0 30px #ff00ff; }
        .rock-title { animation: title-flash 1s ease-in-out infinite alternate; }
        @keyframes title-flash { 0% { text-shadow: 0 0 20px #ff00ff; } 100% { text-shadow: 0 0 40px #00ffcc; } }
        .rock-input, .rock-search { border: 1px solid #ff4500; box-shadow: 0 0 15px #ff4500; }
        .cyber-scroll { border-left: 3px solid #333; }
        .electric-scroll { border-right: 3px solid #00ffcc; box-shadow: inset 0 0 20px rgba(0, 255, 204, 0.3); }
        .gray-row { background: #444 !important; }
        .change-highlight { transition: all 0.3s; }
        .text-success.rock-glow { color: #00ff00 !important; text-shadow: 0 0 10px #00ff00, 0 0 20px #00ffcc; animation: success-pulse 1s infinite; }
        @keyframes success-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.8; transform: scale(1.02); } }
        .text-warning.flash-yellow { color: #ffff00 !important; text-shadow: 0 0 10px #ffff00; animation: flash 0.5s infinite alternate; }
        @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0.5; } }
        .text-danger.pulse-red { color: #ff0000 !important; text-shadow: 0 0 10px #ff0000; animation: danger-pulse 0.8s infinite alternate; }
        .rock-pulse { animation: pulse 1.5s infinite; }
        .btn-magenta { background: linear-gradient(45deg, #ff00ff, #ff4500); box-shadow: 0 0 20px #ff00ff; }
        .btn-magenta:hover { box-shadow: 0 0 30px #ff4500; transform: translateY(-3px); }
        .rock-loaded { animation: loaded-rock 2s ease-out; }
        @keyframes loaded-rock { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        @media (max-width: 576px) { .col-md-6 { padding: 5px; } .rock-title { font-size: 1.5rem; } }
    </style>
</body>
</html>